{{import "../blocks/forms/input"}}
{{import "../icons/heroicons/ChevronUpDown"}}
{{import "../icons/heroicons/Check"}}

{{block dropdownCC(id="", flag="", label="", value="", classes="")}}
<div id="{{id}}" class="dropdown{{if classes}} {{classes}}{{end}}"  @click.away="dropdownOpen = false; clearInput()"
     x-data="{
        dropdownOpen: false,
        items: [],
        filteredItems: [],
        searchQuery: '',
        dataLoaded: false,
        errorMessage: '',
        value: '{{value}}',
        label: '{{label}}',
        flag: '{{ asset("country/" + strlower(flag) + ".svg") }}',

        async loadItems() {
            try {
                const response = await fetch('{{ api("currency.json") }}');
                if (!response.ok) {
                    throw new Error('Failed to load data.');
                }
                this.items = await response.json();
                this.filteredItems = this.items;
                this.dataLoaded = true;
            } catch (error) {
                console.error('Error loading items:', error);
                this.errorMessage = 'Failed to load data.';
            }
        },

        toggleDropdown() {
            this.dropdownOpen = !this.dropdownOpen;

            if (this.dropdownOpen && !this.dataLoaded && !this.errorMessage) {
                this.loadItems();
            }
        },

        focusInput() {
            this.$nextTick(() => this.$refs[`{{id}}-search`]?.focus());
        },

        clearInput() {
            this.searchQuery = '';
            this.filteredItems = this.items;
        },

        filterItems() {
            const query = this.searchQuery.toLowerCase();
            this.filteredItems = this.items.filter(item =>
                item.Name.toLowerCase().includes(query) ||
                item.Code.toLowerCase().includes(query)
            );
        },
        selectItem(item) {
            this.value = item.Code;
            this.label = item.Name;
            this.flag = '{{asset("country")}}/' + item.Flag.toLowerCase() + '.svg';
            this.dropdownOpen = false;
        }
    }">
    <button x-show="!dropdownOpen" @click="toggleDropdown(); focusInput()" class="flex justify-between items-center h-16">
           <div class="flex gap-2 items-center">
            <img :src="flag" width="24" height="24" :alt="value"
            class="h-7 w-7" loading="lazy" />
           <span x-text="value"></span>
           </div>
        {{yield ChevronUpDownHeroIcons(id=(id + "-icon"), classes=" w-6 h-6")}}
   
    </button>
    {{yield inputField(id=(id + "-search"), type="search", placeholder="Enter currency name or code", class="w-full", required=true,
    attrs=map(
        "x-show", "dropdownOpen",
        "x-ref", (id),
        "x-model", "searchQuery",
        "@input", "filterItems"
    )
)}}
    <div class="content" x-show="dropdownOpen"
    x-data="{ showTop: false, showBottom: true }"
         x-transition:enter="ease-out duration-200"
         x-transition:enter-start="-translate-y-2"
         x-transition:enter-end="translate-y-0"
         x-cloak>
         <div 
         class="top-0 bg-gradient-to-b shadow-gradient"
         x-show="showTop"
       ></div>
        <div class="list" @scroll="
        const el = $el;
        showTop = el.scrollTop > 0;
        showBottom = el.scrollTop + el.clientHeight < el.scrollHeight;
      " role="list">
            <template x-if="errorMessage">
                <div class="px-3 py-1.5" x-text="errorMessage"></div>
            </template>
            <template x-if="!errorMessage && filteredItems.length === 0">
                <div class="px-3 py-1.5">Nothing found.</div>
            </template>
            <template x-for="item in filteredItems" :key="item.Code">
                <div class="item" role="listitem" @click="selectItem(item);clearInput()">
                    <div class="flex truncate items-center">
                        <img :src="'{{ asset("/country/' + item.Flag.toLowerCase() + '.svg") }}'" 
                         :alt="item.Code" 
                         class="h-6 w-6 mr-1.5" 
                         width="24" height="24" loading="lazy" />
                    <b x-text="item.Code"></b><span x-text="'&nbsp;-&nbsp;' + item.Name"></span>
                    </div>
                    <template x-if="value === item.Code">
                        {{yield CheckHeroIcons(id=(id + "-check"), classes="ml-auto w-5 h-5 stroke-green-600")}}
                    </template>
                </div>
                
            </template>

        </div>
        <div 
  class="bottom-0 bg-gradient-to-t shadow-gradient"
  x-show="showBottom"
></div>
    </div>
</div>
{{end}}